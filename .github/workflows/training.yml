name: ðŸš€ Manual Model Training & Promotion

on:
  # Allows you to run this workflow manually from the Actions tab [cite: 41]
  workflow_dispatch:

jobs:
  train-and-promote:
    runs-on: self-hosted

    env:
      POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
      POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
      POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
    
    steps:
      - name:  checkout code
        uses: actions/checkout@v4
      
      - name: 1. DEBUG - List all Docker containers
        working-directory: ${{ github.workspace }}
        shell: pwsh
        run: |
          echo "Listing all Docker containers visible to the runner..."
          docker ps -a

      - name: 2. Run the Training Notebook
        id: training
        working-directory: ${{ github.workspace }}
        shell: pwsh
        run: |
          echo "Starting model training..."
            
          # Capture output to a variable
          $output = (docker exec -e MLFLOW_TRACKING_URI=http://mlflow_server:5000 producer /bin/bash -c "jupyter nbconvert --to script src/notebooks/01_model_training.ipynb && python src/notebooks/01_model_training.py")
          
          # Write full output to the action log
          echo $output
          
          # Find the run_id line and extract the ID
          $run_id_line = ($output | Select-String 'MLFLOW_RUN_ID=')
          
          if (-not $run_id_line) {
            echo "::error::Could not find MLFLOW_RUN_ID in training output."
            exit 1
          }
          
          $run_id = $run_id_line.Line.Split('=')[1]
          echo "Found new run ID: $run_id"
          
          # Set the GitHub Actions output variable
          echo "run_id=$run_id" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: 3. Run the Smart Promotion Script
        working-directory: ${{ github.workspace }}
        shell: pwsh
        run: |
          echo "Starting model promotion check..."
          pip install mlflow
          
          # Set environment variables for this step
          $env:NEW_RUN_ID = "${{ steps.training.outputs.run_id }}"
          $env:MLFLOW_TRACKING_URI = "http://mlflow_server:5000"
          
          # Run the Python script
          python scripts/promote_model.py
      - name: 4. (Optional) Restart the Model Service
        if: success()
        working-directory: ${{ github.workspace }}
        shell: pwsh
        run: |
          echo "Restarting model_service to load the new champion model..."
          docker restart model_service